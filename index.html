<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCNEWS | Chronos Chronicles</title>
    <!-- Load Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Supabase SDK for Database/RPC Calls and Auth -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* Custom Styles for Newspaper Aesthetic and Layout */
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Merriweather:wght@300;400&display=swap');
        
        .newspaper-title {
            font-family: 'Playfair Display', serif;
            letter-spacing: -0.05em;
            text-shadow: 2px 2px #0a0a0a;
        }
        .newspaper-body {
            font-family: 'Merriweather', serif;
        }
        
        /* ----------------------------------------------------------------- */
        /* THEME STYLES (DEFAULT DARK MODE, LIGHT MODE DEFINED BY CLASS) */
        /* ----------------------------------------------------------------- */
        
        /* Dark Mode (Default) */
        body.dark-mode {
            background-color: #0d0d0d;
            color: #ffffff;
            transition: all 0.3s;
        }
        .dark-mode .card {
            background-color: #1f2937;
            border-color: #4b5563;
        }
        .dark-mode input, .dark-mode select {
            background-color: #1f2937;
        }

        /* Light Mode */
        body.light-mode {
            background-color: #f8fafc; /* Lighter background */
            color: #1f2937; /* Darker text */
            transition: all 0.3s;
        }
        .light-mode .newspaper-title {
            text-shadow: none;
            color: #0284c7; /* Sky 600 */
        }
        .light-mode .card {
            background-color: #ffffff;
            border-color: #e5e7eb;
            color: #1f2937;
        }
        .light-mode .text-sky-500 { color: #0284c7; } 
        .light-mode .text-gray-400 { color: #4b5563; }
        .light-mode .text-gray-300 { color: #374151; }
        .light-mode .text-gray-500 { color: #6b7280; }
        .light-mode .border-b { border-color: #d1d5db; }
        .light-mode .border-t { border-color: #d1d5db; }
        .light-mode .bg-gray-700, .light-mode .bg-gray-800 { background-color: #e5e7eb; }
        .light-mode input, .light-mode select {
            background-color: #ffffff;
            border-color: #d1d5db;
            color: #1f2937;
        }

    </style>
</head>
<body class="newspaper-body dark-mode">

    <!-- CRITICAL: Supabase Configuration -->
    <script>
        // --- SUPABASE CONFIGURATION ---
        // ðŸš¨ IMPORTANT: You MUST replace these placeholder values with your actual Supabase keys ðŸš¨
        
        // 1. Replace with your Project URL
        const SUPABASE_URL = 'https://glxpstrupjohubotpvkg.supabase.co'; 
        
        // 2. Replace with your Project Anon (public) Key
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdseHBzdHJ1cGpvaHVib3RwdmtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyNDEwMTIsImV4cCI6MjA3NjgxNzAxMn0.glG8liZrM-PQ8Abwi76v1iHvfwCoMRf855eGUVPE1ek';
        
        // Auth state toggle (default to Sign In)
        let isRegisterMode = false;

        // MOCK DATA: Collaboration details for the new sub-page view
        const collaborations = {
            'astroashib': {
                name: 'AstroAshib ($ASHIB)',
                supply_percent: '1%',
                status: 'Coming Soon',
                partner_profile: '@AstroShibCro',
                partner_link: 'https://twitter.com/AstroShibCro',
                goal: 'Drive high-value engagement on Twitter.',
                bio: 'Official Twitter for the AstroAshib ($ASHIB) community on Cronos. We are building the next generation of DeFi utility with a focus on community empowerment and cross-chain collaboration. Home of the #AshibArmy. Follow for campaign updates!',
                details: [
                    "Reward Pool: A massive 1% of the total VCNEWS point supply is reserved for participants who successfully complete the campaign tasks.",
                    "Campaign Duration: To be announced upon launch.",
                    "Tasks: Retweet, comment, and use specific hashtags."
                ]
            },
            'project_two': {
                name: 'Future Project Collaboration',
                supply_percent: 'TBA',
                status: 'Pipeline',
                partner_profile: 'TBA',
                partner_link: '#',
                goal: 'Expand cross-community utility and awareness.',
                bio: 'Actively establishing partnerships with other high-potential projects. Check back soon for the next campaign announcement!',
                details: []
            }
        };
    </script>

    <div id="app-container" class="max-w-4xl mx-auto p-4 md:p-8">
        <!-- Message Box -->
        <div id="message-box" class="fixed top-0 left-1/2 -translate-x-1/2 p-4 mt-2 rounded-lg z-50 transition-opacity duration-300 opacity-0 hidden"></div>
        
        <!-- Header / Navigation -->
        <header class="mb-8 border-b border-sky-500 pb-4 flex flex-col sm:flex-row justify-between items-center sm:space-y-0 space-y-4">
            <h1 class="newspaper-title text-4xl sm:text-5xl text-sky-500">VCNEWS</h1>
            <nav id="main-nav" class="flex flex-wrap justify-center space-x-3 text-sm sm:text-base">
                <button onclick="navigate('login')" class="nav-button hover:text-sky-400 transition-colors text-red-400 font-bold">Login</button>
                <button onclick="navigate('feed')" class="nav-button hover:text-sky-400 transition-colors">News Feed</button>
                <button onclick="navigate('quests')" class="nav-button hover:text-sky-400 transition-colors">Quests</button>
                <button onclick="navigate('profile')" class="nav-button hover:text-sky-400 transition-colors">Portfolio</button>
                <button onclick="navigate('collabs')" class="nav-button hover:text-sky-400 transition-colors">Collabs</button> 
                <button onclick="navigate('about')" class="nav-button hover:text-sky-400 transition-colors">About</button>
                <!-- NEW: Theme Toggle Button -->
                <button onclick="toggleTheme()" class="nav-button hover:text-yellow-400 transition-colors text-xl">
                    <span id="theme-icon">ðŸ”†</span>
                </button>
            </nav>
        </header>

        <!-- Main Content Views -->
        <main id="views">
            
            <!-- --------------------------------- -->
            <!-- VIEW 1: LOGIN / REGISTER PAGE -->
            <!-- --------------------------------- -->
            <div id="view-login" class="view-content flex flex-col items-center justify-center text-center h-[70vh]">
                <h2 class="newspaper-title text-3xl mb-4 text-sky-500">Access Chronos Chronicles</h2>
                <p class="mb-8 text-gray-400" id="auth-subtitle">Sign in to track your points and start mining VCNEWS.</p>
                
                <div class="card p-6 rounded-xl shadow-2xl w-full max-w-sm border border-gray-700">
                    
                    <div id="auth-forms">
                        <h3 class="text-2xl font-bold mb-4" id="auth-form-title">Sign In</h3>

                        <!-- Username is optional for Supabase but good for UX -->
                        <div id="username-field" class="mb-3 hidden">
                            <input id="auth-username" type="text" placeholder="Username (Optional)" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                        </div>
                        
                        <input id="auth-email" type="email" placeholder="Email Address" class="w-full p-3 mb-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                        <input id="auth-password" type="password" placeholder="Password (min 6 chars)" class="w-full p-3 mb-4 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500" />
                        
                        <!-- Supabase Action Button -->
                        <button id="supabase-auth-button" onclick="handleSupabaseAuth()" class="bg-sky-500 hover:bg-sky-600 text-black font-bold py-3 px-6 rounded-lg w-full transition duration-300 mb-4">
                            Sign In
                        </button>
                        
                        <!-- Toggle Sign Up/Sign In -->
                        <p class="text-xs text-gray-400 mt-4">
                            <span id="auth-toggle-text">Don't have an account?</span>
                            <button onclick="toggleAuthMode()" class="text-sky-400 hover:text-sky-300 font-bold transition">
                                <span id="auth-toggle-link">Register</span>
                            </button>
                        </p>

                    </div>
                    
                    <p id="user-info" class="text-sm text-gray-500 mt-4 hidden"></p>
                    <button onclick="logout()" class="text-xs text-red-500 mt-6 hover:text-red-400 transition hidden" id="logout-link">Log Out</button>

                </div>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 2: NEWS FEED -->
            <!-- --------------------------------- -->
            <div id="view-feed" class="view-content hidden">
                <h2 class="newspaper-title text-3xl mb-6 border-b border-gray-700 pb-3">Today's Chronos News Digest</h2>

                <!-- Filtering and Sorting Bar -->
                <div class="card p-4 mb-8 rounded-xl flex flex-wrap gap-4 items-center border border-gray-700">
                    <span class="text-sm font-bold text-gray-300 mr-2">Filter/Sort:</span>
                    
                    <select id="filter-topic" class="p-2 rounded-lg bg-gray-700 text-white text-sm border-gray-600" onchange="fetchNewsFeed(true)">
                        <option value="">All Topics</option>
                        <option value="Crypto">Crypto</option>
                        <option value="Market">Market Analysis</option>
                        <option value="Tech">Tech</option>
                        <option value="Project Update">Project Update</option>
                    </select>
                    
                    <select id="sort-order" class="p-2 rounded-lg bg-gray-700 text-white text-sm border-gray-600" onchange="fetchNewsFeed(true)">
                        <option value="date_desc">Latest Date</option>
                        <option value="date_asc">Oldest Date</option>
                        <option value="points_desc">Highest Points</option>
                        <option value="points_asc">Lowest Points</option>
                    </select>
                    
                </div>

                <div id="news-list" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- News cards will be inserted here by JavaScript -->
                </div>
                <div id="feed-loading" class="text-center text-gray-500 mt-12">
                    <svg class="animate-spin h-6 w-6 text-sky-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    Loading articles...
                </div>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 3: ARTICLE DETAIL -->
            <!-- --------------------------------- -->
            <div id="view-article" class="view-content hidden">
                <button onclick="navigate('feed')" class="text-sky-500 hover:text-sky-400 mb-6 flex items-center transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back to Feed
                </button>
                <article class="card p-6 rounded-xl shadow-2xl border-t-4 border-sky-500">
                    <h1 id="article-title" class="newspaper-title text-4xl mb-4 leading-none"></h1>
                    <div class="flex justify-between text-xs text-gray-400 mb-6 border-b border-gray-700 pb-3">
                        <span id="article-date-category"></span>
                    </div>
                    
                    <div class="lg:columns-2 lg:gap-8">
                        <img id="article-image" class="w-full h-auto mb-6 rounded-lg object-cover" src="" onerror="this.style.display='none'">
                        <p id="article-intro" class="text-lg font-bold mb-6 italic text-gray-300"></p>
                        <div id="article-content" class="text-gray-300 text-base leading-relaxed">
                            <!-- Main content paragraphs inserted here -->
                        </div>
                    </div>
                    
                    <div class="mt-8 pt-6 border-t border-gray-700 flex justify-between items-center flex-wrap gap-4">
                        <button id="claim-button" onclick="" class="bg-green-600 hover:bg-green-700 text-black font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 text-lg">
                            Claim <span id="claim-points">0</span> VCNEWS
                        </button>
                        <div id="article-sources" class="text-sm text-gray-500">
                            <!-- Sources/Links inserted here -->
                        </div>
                    </div>
                </article>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 4: DAILY QUESTS -->
            <!-- --------------------------------- -->
            <div id="view-quests" class="view-content hidden">
                <h2 class="newspaper-title text-3xl mb-6 border-b border-gray-700 pb-3">Daily Engagement Quests</h2>
                <p class="text-gray-400 mb-6">Complete the active quest to earn a large boost of VCNEWS points!</p>
                <div id="quest-card" class="card p-6 rounded-xl border-l-4 border-yellow-500">
                    <div id="quest-loading" class="text-center text-gray-500">
                        <svg class="animate-spin h-6 w-6 text-yellow-500 mx-auto mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        Loading daily quest...
                    </div>
                </div>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 5: PORTFOLIO/DASHBOARD -->
            <!-- --------------------------------- -->
            <div id="view-profile" class="view-content hidden">
                <h2 class="newspaper-title text-3xl mb-6 border-b border-gray-700 pb-3">My VCNEWS Portfolio</h2>

                <!-- Points and Status Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card p-6 rounded-xl border-b-4 border-sky-500">
                        <p class="text-sm text-gray-400">Total VCNEWS Points Mined</p>
                        <p id="profile-points" class="newspaper-title text-5xl text-sky-500 mt-1 transition-transform transform hover:scale-[1.02]">0</p>
                    </div>
                    <div class="card p-6 rounded-xl border-b-4 border-sky-500">
                        <p class="text-sm text-gray-400">Account Status</p>
                        <p class="text-xl text-green-500 mt-2 font-bold">Active Miner</p>
                        <p class="text-xs text-gray-500 mt-2">Email: <span id="profile-email">...</span></p>
                    </div>
                    <div class="card p-6 rounded-xl border-b-4 border-green-500 flex flex-col justify-between">
                        <p class="text-sm text-gray-400">Token Generation Event (TGE)</p>
                        <div class="mt-2">
                            <p class="text-xl font-bold text-white">1 VCNEWS = 1 Real Token</p>
                            <p class="text-xs text-gray-300 mt-1">Conversion available at TGE end date.</p>
                        </div>
                    </div>
                </div>

                <!-- NEW: TWITTER/X REGISTRATION CARD -->
                <div class="card p-6 rounded-xl border-b-4 border-sky-500 mt-6">
                    <h3 class="text-2xl font-bold text-sky-400 mb-4">Twitter (X) Username</h3>
                    <div id="twitter-display-section" class="space-y-3">
                        <p class="text-gray-400">Loading profile status...</p>
                    </div>
                </div>
                <!-- END NEW SECTION -->

                <!-- NEW: WALLET REGISTRATION CARD -->
                <div class="card p-6 rounded-xl border-b-4 border-purple-500 mt-6">
                    <h3 class="text-2xl font-bold text-purple-400 mb-4">EVM Wallet Registration</h3>
                    <div id="wallet-display-section" class="space-y-3">
                        <!-- Wallet status/form will be rendered by JS -->
                        <p class="text-gray-400">Loading wallet status...</p>
                    </div>
                </div>
                <!-- END NEW SECTION -->
                
                <!-- Leaderboard Section (REAL TIME MOCKUP) -->
                <div class="mt-8 border-t border-gray-700 pt-6">
                    <h3 class="text-2xl font-bold mb-4 text-sky-500">Global Leaderboard (Top 5 Miners)</h3>
                    <div id="leaderboard-container" class="space-y-2">
                        <!-- Leaderboard content will be dynamically loaded here -->
                        <div class="text-center text-gray-500">Loading leaderboard...</div>
                    </div>
                    <!-- User's own rank card -->
                    <div class="flex justify-between items-center card p-3 rounded-lg border-l-4 border-sky-500 mt-4">
                        <span class="font-bold text-sky-500">#<span id="leaderboard-user-rank">...</span></span>
                        <span class="text-lg font-bold">Your Rank</span>
                        <span id="leaderboard-user-points" class="font-bold text-green-400">0 VCNEWS</span>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="mt-8 border-t border-gray-700 pt-6">
                    <h3 class="text-2xl font-bold mb-4 text-sky-500">Recent Activity</h3>
                    <div id="activity-log" class="space-y-3">
                        <p class="text-gray-500">Activity will load here...</p>
                    </div>
                </div>

                <button onclick="logout()" class="mt-8 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-full transition duration-300">
                    Log Out
                </button>
            </div>
            
            <!-- --------------------------------- -->
            <!-- VIEW 6: ABOUT / INFO PAGE (CLEANED) -->
            <!-- --------------------------------- -->
            <div id="view-about" class="view-content hidden">
                <h2 class="newspaper-title text-3xl mb-6 border-b border-gray-700 pb-3">About VCNEWS: Chronos Chronicles</h2>
                
                <div class="card p-6 rounded-xl shadow-2xl space-y-6">
                    <p class="text-lg font-bold text-sky-500">Project Overview: The Chronos Engine</p>
                    <p class="text-gray-300">
                        VCNEWS is more than just a news feed; it is the <strong>Chronos Engine</strong>â€”the dedicated engagement layer for the Chronos Chronicles token project. We empower our community by directly rewarding knowledge acquisition and participation. Our system allows users to "mine" utility points, known as <strong>VCNEWS points</strong>, by performing key activities like reading verified articles and engaging in strategic daily quests. This system is crucial for building a strong, active, and well-informed token holder base.
                    </p>
                    
                    <p class="text-lg font-bold text-sky-500 pt-4 border-t border-gray-700">VCNEWS Tokenomics & Utility</p>
                    <ul class="list-disc list-inside space-y-2 text-gray-300 ml-4">
                        <li><strong>Core Utility:</strong> 1 VCNEWS Point earned today will be exchangeable for 1 unit of the Real Chronos Token at the Token Generation Event (TGE).</li>
                        <li><strong>Scarcity Model:</strong> Total daily VCNEWS point issuance is algorithmically capped and transparently calculated. This ensures a predictable inflationary/deflationary pressure leading up to the TGE.</li>
                        <li><strong>Earning Mechanism:</strong> Points are primarily earned through two methods: <strong>Article Claim</strong> (Verifying consumption of high-value content) and <strong>Daily Quests</strong> (External actions like social media participation).</li>
                        <li><strong>Future Utility:</strong> Upcoming features include point staking to earn passive rewards and governance rights tied to point accumulation.</li>
                    </ul>
                    
                    <!-- FAQ Section -->
                    <p class="text-lg font-bold text-sky-500 pt-4 border-t border-gray-700">Frequently Asked Questions (FAQ)</p>
                    <div class="space-y-4">
                        <!-- FAQ Item 1 -->
                        <details class="bg-gray-800 p-3 rounded-lg cursor-pointer">
                            <summary class="font-semibold text-white hover:text-sky-400 transition-colors">How do I convert my VCNEWS points to tokens?</summary>
                            <p class="text-gray-400 mt-2 ml-4 text-sm">
                                Conversion will happen automatically at the scheduled Token Generation Event (TGE). Your total accumulated VCNEWS points will be mapped 1:1 to real Chronos Tokens. You must hold your points in your account until that time.
                            </p>
                        </details>
                        <!-- FAQ Item 2 -->
                        <details class="bg-gray-800 p-3 rounded-lg cursor-pointer">
                            <summary class="font-semibold text-white hover:text-sky-400 transition-colors">Why do some articles offer more points?</summary>
                            <p class="text-gray-400 mt-2 ml-4 text-sm">
                                Points are weighted based on the article's importance, research depth, and strategic relevance to the Chronos ecosystem. Higher point articles often require more careful reading or include critical project updates.
                            </p>
                        </details>
                        <!-- FAQ Item 3 -->
                        <details class="bg-gray-800 p-3 rounded-lg cursor-pointer">
                            <summary class="font-semibold text-white hover:text-sky-400 transition-colors">What happens if I try to claim points twice?</summary>
                            <p class="text-gray-400 mt-2 ml-4 text-sm">
                                Our system (via Supabase RPC) securely logs all activity. Once an `article_claim` or `daily_quest` is logged for your user ID and context ID (or date), any subsequent attempts will fail, and you will receive a message that the claim has already been processed.
                            </p>
                        </details>
                    </div>

                    <p class="text-lg font-bold text-sky-500 pt-4 border-t border-gray-700">Connect with Chronos & Our Founder</p>
                    <div class="flex flex-wrap space-x-6 text-xl">
                        <!-- NEW: Project Twitter -->
                        <a href="https://twitter.com/VCNEWS_ON_CRO" target="_blank" class="text-gray-400 hover:text-sky-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.77.35-1.6.58-2.47.65.89-.53 1.57-1.37 1.89-2.37-.84.5-1.78.87-2.79 1.07C18.42 4.29 17.3 4 16.03 4c-2.48 0-4.5 2.02-4.5 4.5 0 .35.04.69.11 1.02-3.73-.18-7.05-1.98-9.27-4.71-.39.67-.61 1.46-.61 2.3 0 1.56.79 2.94 1.99 3.74-.73-.02-1.41-.22-2.01-.55v.06c0 2.18 1.55 4 3.6 4.42-.3.08-.61.12-.93.12-.23 0-.46-.02-.68-.06.57 1.79 2.24 3.09 4.25 3.12C7.96 19.5 5.25 20.25 2 20.25c-.5 0-.99-.03-1.47-.09 2.12 1.35 4.63 2.14 7.37 2.14 8.87 0 13.7-7.35 13.7-13.7 0-.21-.01-.41-.03-.62.94-.67 1.75-1.5 2.4-2.43z"/></svg>
                            Project Twitter (@VCNEWS_ON_CRO)
                        </a>
                        <!-- Founder's Twitter -->
                        <a href="https://twitter.com/FAVIGAL1" target="_blank" class="text-gray-400 hover:text-sky-500 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block" viewBox="0 0 24 24" fill="currentColor"><path d="M22.46 6c-.77.35-1.6.58-2.47.65.89-.53 1.57-1.37 1.89-2.37-.84.5-1.78.87-2.79 1.07C18.42 4.29 17.3 4 16.03 4c-2.48 0-4.5 2.02-4.5 4.5 0 .35.04.69.11 1.02-3.73-.18-7.05-1.98-9.27-4.71-.39.67-.61 1.46-.61 2.3 0 1.56.79 2.94 1.99 3.74-.73-.02-1.41-.22-2.01-.55v.06c0 2.18 1.55 4 3.6 4.42-.3.08-.61.12-.93.12-.23 0-.46-.02-.68-.06.57 1.79 2.24 3.09 4.25 3.12C7.96 19.5 5.25 20.25 2 20.25c-.5 0-.99-.03-1.47-.09 2.12 1.35 4.63 2.14 7.37 2.14 8.87 0 13.7-7.35 13.7-13.7 0-.21-.01-.41-.03-.62.94-.67 1.75-1.5 2.4-2.43z"/></svg>
                            Founder's Twitter (@FAVIGAL1)
                        </a>
                    </div>
                </div>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 7: COMMUNITY COLLABS HUB (LIST) -->
            <!-- --------------------------------- -->
            <div id="view-collabs" class="view-content hidden">
                <h2 class="newspaper-title text-3xl mb-6 border-b border-gray-700 pb-3">Community Collaborations Hub</h2>
                <p class="text-gray-400 mb-6">
                    We are thrilled to announce a major collaboration with the <strong>AstroAshib</strong> ($ASHIB) community! This partnership is designed to reward cross-platform engagement between our projects.
                    <br><br>
                    We are actively establishing partnerships with <strong>other high-potential projects</strong>. These new collaborations will be announced soon, providing continuous opportunities for the community to earn VCNEWS points. Click a campaign below for full details and reward pools.
                </p>
                <div id="collabs-list" class="space-y-4">
                    <!-- Collaboration list items will be generated by JS (renderCollabsList) -->
                </div>
            </div>

            <!-- --------------------------------- -->
            <!-- VIEW 8: COLLAB DETAIL PAGE (SUB-PAGE) -->
            <!-- --------------------------------- -->
            <div id="view-collab-detail" class="view-content hidden">
                 <button onclick="navigate('collabs')" class="text-sky-500 hover:text-sky-400 mb-6 flex items-center transition-colors font-bold">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                    Back to Collabs Hub
                </button>
                <article class="card p-6 rounded-xl shadow-2xl border-t-4 border-purple-500">
                    <h1 id="collab-detail-title" class="newspaper-title text-4xl mb-4 leading-none text-purple-400"></h1>
                    <div id="collab-detail-content">
                        <!-- Content dynamically loaded here by renderCollabDetail() -->
                    </div>
                </article>
            </div>

        </main>

        <!-- Footer -->
        <footer class="mt-12 pt-4 text-center text-xs text-gray-600 border-t border-gray-800">
            Chronos Chronicles: VCNEWS Point Mining Platform
        </footer>

    </div>

    <!-- ----------------------------------------------------- -->
    <!-- 2. CORE JAVASCRIPT LOGIC (SUPABASE ONLY) -->
    <!-- ----------------------------------------------------- -->
    <script type="module">
        // --- Global Variables ---
        let supabaseClient;
        let userId = null; 
        let userEmail = null;
        
        // --- DOM Elements ---
        const views = {
            login: document.getElementById('view-login'),
            feed: document.getElementById('view-feed'),
            article: document.getElementById('view-article'),
            quests: document.getElementById('view-quests'),
            profile: document.getElementById('view-profile'),
            about: document.getElementById('view-about'),
            collabs: document.getElementById('view-collabs'), 
            collab_detail: document.getElementById('view-collab-detail'), 
        };
        const messageBox = document.getElementById('message-box');
        
        // --- Utility Functions ---

        /** Toggles between Light and Dark mode */
        window.toggleTheme = function() {
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');

            if (body.classList.contains('dark-mode')) {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.textContent = 'ðŸŒ™'; // Moon icon for light mode
                localStorage.setItem('theme', 'light');
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.textContent = 'ðŸ”†'; // Sun icon for dark mode
                localStorage.setItem('theme', 'dark');
            }
        }
        
        /** Applies saved theme from localStorage on load */
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark'; // Default to dark
            const body = document.body;
            const themeIcon = document.getElementById('theme-icon');

            if (savedTheme === 'light') {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                themeIcon.textContent = 'ðŸŒ™';
            } else {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                themeIcon.textContent = 'ðŸ”†';
            }
        }


        /** Displays a temporary, dismissible message */
        function showMessage(msg, type = 'info') {
            let bgColor = 'bg-sky-600'; // Default info
            if (type === 'success') bgColor = 'bg-green-600';
            if (type === 'error') bgColor = 'bg-red-600';

            messageBox.textContent = msg;
            messageBox.className = `fixed top-0 left-1/2 -translate-x-1/2 p-4 mt-2 rounded-lg z-50 transition-opacity duration-300 ${bgColor} text-white shadow-xl`;
            messageBox.classList.remove('hidden');
            messageBox.classList.add('opacity-100');

            setTimeout(() => {
                messageBox.classList.remove('opacity-100');
                messageBox.classList.add('opacity-0');
                setTimeout(() => messageBox.classList.add('hidden'), 300);
            }, 5000);
        }

        /** Handles SPA view switching */
        window.navigate = function(viewId, data = null) {
            // Protect authenticated views
            if (!userId && viewId !== 'login' && viewId !== 'about' && viewId !== 'collabs' && viewId !== 'collab_detail') {
                showMessage("Please sign in to access this page.", 'error');
                viewId = 'login';
            }
            
            Object.values(views).forEach(el => el.classList.add('hidden'));
            views[viewId].classList.remove('hidden');

            // Trigger specific page load logic
            if (viewId === 'feed') fetchNewsFeed();
            if (viewId === 'profile') fetchUserProfile();
            if (viewId === 'quests') fetchDailyQuest();
            if (viewId === 'article' && data) renderArticle(data);
            if (viewId === 'login') updateLoginUI(); 
            if (viewId === 'collabs') renderCollabsList(); 
            if (viewId === 'collab_detail' && data) renderCollabDetail(data); 

            window.scrollTo(0, 0); // Scroll to top on navigation
        }

        /** Renders complex JSONB content from Supabase as HTML */
        function renderContentBlocks(contentJson) {
            // Ensure contentJson is an array before trying to iterate over it
            if (!Array.isArray(contentJson)) {
                console.error("Article content is not an array:", contentJson);
                return '<p class="text-red-400">Error: Article content format is invalid.</p>';
            }
            
            let html = '';
            contentJson.forEach(block => {
                if (block.type === 'paragraph' && block.text) {
                    html += `<p class="mb-4 text-gray-300">${block.text}</p>`;
                }
            });
            return html;
        }

        /** Formats date to a readable string */
        function formatDate(dateString) {
            const options = { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' };
            return new Date(dateString).toLocaleDateString(undefined, options);
        }

        // --- Authentication UI/State Management ---

        /** Toggles between Sign In and Register mode */
        window.toggleAuthMode = function() {
            isRegisterMode = !isRegisterMode;
            const title = document.getElementById('auth-form-title');
            const button = document.getElementById('supabase-auth-button');
            const toggleText = document.getElementById('auth-toggle-text');
            const toggleLink = document.getElementById('auth-toggle-link');
            const subtitle = document.getElementById('auth-subtitle');
            const usernameField = document.getElementById('username-field');

            if (isRegisterMode) {
                title.textContent = 'Create Account';
                button.textContent = 'Register';
                toggleText.textContent = 'Already have an account?';
                toggleLink.textContent = 'Sign In';
                subtitle.textContent = 'Register to start your mining journey.';
                usernameField.classList.remove('hidden');
            } else {
                title.textContent = 'Sign In';
                button.textContent = 'Sign In';
                toggleText.textContent = 'Don\'t have an account?';
                toggleLink.textContent = 'Register';
                subtitle.textContent = 'Sign in to track your points and start mining VCNEWS.';
                usernameField.classList.add('hidden');
            }
        }

        /** Updates the Login/Logout UI based on current session */
        function updateLoginUI() {
            const isLoggedIn = !!userId;
            
            document.getElementById('auth-forms').classList.toggle('hidden', isLoggedIn);
            document.getElementById('user-info').classList.toggle('hidden', !isLoggedIn);
            document.getElementById('logout-link').classList.toggle('hidden', !isLoggedIn);
            
            if (isLoggedIn) {
                 document.getElementById('user-info').textContent = userEmail ? 
                    `Signed in as: ${userEmail}` :
                    `Signed in.`;
                 document.getElementById('profile-email').textContent = userEmail;
            }
        }

        // --- Supabase Authentication Functions ---

        /** Main handler for the Supabase Sign In/Register button */
        window.handleSupabaseAuth = async function() {
            if (!supabaseClient) {
                 showMessage("Supabase client is not configured/initialized. Please check console for details.", 'error');
                 return;
            }
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const username = document.getElementById('auth-username').value;
            
            if (!email || !password) {
                showMessage('Please enter both email and password.', 'error');
                return;
            }

            const button = document.getElementById('supabase-auth-button');
            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>LOADING...</span>';
            
            try {
                if (isRegisterMode) {
                    await supabaseSignUp(email, password, username);
                } else {
                    await supabaseSignIn(email, password);
                }
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }

        /** Supabase Sign Up */
        async function supabaseSignUp(email, password, username) {
            const { data, error } = await supabaseClient.auth.signUp({ email, password, options: { data: { username: username || email.split('@')[0] } } });
            
            if (error) {
                showMessage(`Registration failed: ${error.message}`, 'error');
                return;
            }

            if (data.user) {
                // Supabase typically requires email confirmation. 
                showMessage('Registration successful! Check your email to confirm your account, then sign in.', 'success');
                toggleAuthMode(); // Switch to sign-in mode
            } else if (data.session === null) {
                // If the user is created but no session is returned (i.e., email confirmation required)
                showMessage('Registration successful! A confirmation link has been sent to your email. Please click it to sign in.', 'success');
                toggleAuthMode();
            }
        }

        /** Supabase Sign In */
        async function supabaseSignIn(email, password) {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

            if (error) {
                showMessage(`Login failed: ${error.message}`, 'error');
                return;
            }

            if (data.user) {
                userId = data.user.id;
                userEmail = data.user.email;
                showMessage("Login successful! Redirecting to feed...", 'success');
                navigate('feed');
            }
        }
        
        /** Triggered by the UI logout button */
        window.logout = async function() {
            try {
                await supabaseClient.auth.signOut(); 

                userId = null;
                userEmail = null;

                showMessage("You have been signed out.", 'info');
                navigate('login');
            } catch (error) {
                showMessage("Logout failed.", 'error');
                console.error("Logout Error:", error);
            }
        }

        // --- Initialization (Supabase Only) ---

        /** Initializes Supabase client and sets up auth listener */
        async function initApp() {
            try {
                // 1. Initialize Supabase Client
                supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase Client Initialized.");
                
                // 2. Apply theme from storage
                applySavedTheme();

                // 3. Set up Auth listener
                const { data: { session } } = await supabaseClient.auth.getSession();
                
                if (session && session.user) {
                    userId = session.user.id;
                    userEmail = session.user.email;
                    updateLoginUI();
                    navigate('feed');
                } else {
                    // Start on the login page if not authenticated
                    navigate('login');
                }

                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (session && session.user) {
                        userId = session.user.id;
                        userEmail = session.user.email;
                        updateLoginUI();
                        if (event === 'SIGNED_IN') { navigate('feed'); } // Only navigate on fresh sign-in
                    } else if (event === 'SIGNED_OUT') {
                        userId = null;
                        userEmail = null;
                        updateLoginUI();
                        navigate('login');
                    }
                });

            } catch (error) {
                console.error("Initialization Error:", error);
                // If the API key is truly invalid, the client setup itself might throw.
                if (SUPABASE_URL === 'YOUR_SUPABASE_PROJECT_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                    showMessage("CRITICAL: Please replace the placeholder SUPABASE_URL and SUPABASE_ANON_KEY in the code.", 'error');
                } else {
                    showMessage(`Initialization failed: ${error.message}`, 'error');
                }
            }
        }

        // --- Wallet Submission Logic ---

        /** Submits or updates the user's EVM wallet address to Supabase. */
        window.submitWalletAddress = async function() {
            if (!userId) {
                showMessage("You must be logged in to submit a wallet address.", 'error');
                return;
            }

            const input = document.getElementById('wallet-address-input');
            const walletAddress = input.value.trim();
            const button = document.getElementById('wallet-submit-button');

            // 1. Client-side Validation (Standard EVM format: 0x followed by 40 hex chars)
            const evmRegex = /^0x[a-fA-F0-9]{40}$/;

            if (!evmRegex.test(walletAddress)) {
                showMessage("Invalid EVM wallet address format. Must be 42 characters long and start with '0x'.", 'error');
                input.classList.add('border-red-500');
                return;
            }
            input.classList.remove('border-red-500');

            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>SUBMITTING...</span>';

            try {
                // 2. Insert/Update into 'user_wallets' table
                // onConflict: 'user_id' ensures that if the user already has a wallet, it updates it (upsert).
                const { data, error } = await supabaseClient
                    .from('user_wallets')
                    .upsert({
                        user_id: userId,
                        wallet_address: walletAddress,
                        status: 'pending' // Always reset to pending on update
                    }, { 
                        onConflict: 'user_id', 
                        ignoreDuplicates: false 
                    })
                    .select();

                if (error) {
                    // Check for unique constraint violation on wallet_address (code 23505)
                    if (error.code === '23505' && error.message.includes('wallet_address')) {
                        showMessage("This wallet address is already linked to another account. You can only link one wallet per account, and each wallet can only be linked once.", 'error');
                    } else {
                        showMessage(`Wallet submission failed: ${error.message}`, 'error');
                    }
                    console.error("Wallet Submission Error:", error);
                    return;
                }

                showMessage("Wallet submitted successfully! It is now pending verification.", 'success');
                // Refresh the profile page to show the pending status
                fetchUserProfile(); 

            } catch (error) {
                showMessage(`An unexpected error occurred during submission.`, 'error');
                console.error("Submission Catch Error:", error);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }
        
        /** Submits the user's Twitter/X username to Supabase. */
        window.submitTwitterUsername = async function() {
            if (!userId) {
                showMessage("You must be logged in to submit a username.", 'error');
                return;
            }

            const input = document.getElementById('twitter-username-input');
            let username = input.value.trim();
            const button = document.getElementById('twitter-submit-button');

            // Sanitize input: remove leading '@' symbol if present
            if (username.startsWith('@')) {
                username = username.substring(1);
            }

            // Client-side validation: must be a valid Twitter username format (alphanumeric, 4-15 chars, no special chars)
            // A simplified check is just to ensure it's not empty and doesn't contain spaces.
            const usernameRegex = /^[a-zA-Z0-9_]{4,15}$/;

            if (!usernameRegex.test(username)) {
                showMessage("Invalid X username format. Use 4-15 letters, numbers, or underscores (no spaces or '@').", 'error');
                input.classList.add('border-red-500');
                return;
            }
            input.classList.remove('border-red-500');

            const originalText = button.textContent;
            button.disabled = true;
            button.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>SUBMITTING...</span>';

            try {
                // Insert/Update into 'user_social_profiles' table
                const { error } = await supabaseClient
                    .from('user_social_profiles')
                    .upsert({
                        user_id: userId,
                        platform: 'twitter', // Hardcoded platform identifier
                        username: username
                    }, { 
                        onConflict: 'user_id, platform', // Upsert based on user and platform
                        ignoreDuplicates: false 
                    })
                    .select();

                if (error) {
                    if (error.code === '23505' && error.message.includes('username')) {
                         showMessage("This X username is already linked to another VCNEWS account.", 'error');
                    } else {
                        showMessage(`Username submission failed: ${error.message}`, 'error');
                    }
                    console.error("Twitter Submission Error:", error);
                    return;
                }

                showMessage("X Username submitted successfully!", 'success');
                // Refresh the profile page to show the submitted username
                fetchUserProfile(); 

            } catch (error) {
                showMessage(`An unexpected error occurred during username submission.`, 'error');
                console.error("Submission Catch Error:", error);
            } finally {
                button.textContent = originalText;
                button.disabled = false;
            }
        }


        // --- Data Fetching & Rendering ---

        async function fetchNewsFeed(isFiltered = false) {
            if (!supabaseClient) return;

            document.getElementById('news-list').innerHTML = '';
            document.getElementById('feed-loading').classList.remove('hidden');
            
            // GET FILTER/SORT VALUES
            const topic = document.getElementById('filter-topic').value;
            const sort = document.getElementById('sort-order').value;
            
            let query = supabaseClient
                .from('news_articles')
                .select('*')
                .limit(6);

            // 1. Filtering by Topic
            if (topic) {
                query = query.eq('category', topic);
            }

            // 2. Sorting
            let orderColumn = 'date_published';
            let ascending = false;

            if (sort.startsWith('date')) {
                orderColumn = 'date_published';
                ascending = sort === 'date_asc';
            } else if (sort.startsWith('points')) {
                orderColumn = 'vcnews_claim_points';
                ascending = sort === 'points_asc';
            }

            query = query.order(orderColumn, { ascending: ascending });


            try {
                const { data, error } = await query;

                document.getElementById('feed-loading').classList.add('hidden');
                
                if (error) throw error;
                
                if (data.length === 0) {
                    document.getElementById('news-list').innerHTML = '<p class="text-center col-span-full text-gray-500 mt-8">No articles found matching your current criteria. Please reset filters.</p>';
                    return;
                }
                
                if(isFiltered) showMessage('Filters applied successfully.', 'info');


                data.forEach(article => {
                    const card = document.createElement('div');
                    card.className = 'card p-6 rounded-xl shadow-lg hover:shadow-xl transition-all cursor-pointer flex flex-col justify-between transform hover:scale-[1.01] border border-gray-700';
                    card.onclick = () => navigate('article', article);
                    
                    const imageUrl = article.featured_image_url || `https://placehold.co/600x300/1e293b/94a3b8?text=${article.category.toUpperCase()}`;

                    card.innerHTML = `
                        <div>
                            <img src="${imageUrl}" alt="Featured image for ${article.title}" class="rounded-lg mb-4 w-full h-48 object-cover">
                            <span class="text-xs font-semibold text-sky-400 uppercase">${article.category}</span>
                            <h3 class="newspaper-title text-2xl mt-1 mb-2 leading-tight">${article.title}</h3>
                            <p class="text-gray-400 text-sm mb-4 line-clamp-3">${article.introduction}</p>
                        </div>
                        <div class="flex justify-between items-center pt-2 border-t border-gray-700">
                            <span class="text-xs text-gray-500">${formatDate(article.date_published)}</span>
                            <span class="text-sm font-bold text-green-400">${article.vcnews_claim_points} VCNEWS</span>
                        </div>
                    `;
                    document.getElementById('news-list').appendChild(card);
                });

            } catch (error) {
                document.getElementById('feed-loading').classList.add('hidden');
                showMessage(`Error loading feed: ${error.message}`, 'error');
                console.error("Feed Fetch Error:", error);
            }
        }
        function renderArticle(article) {
            document.getElementById('article-title').textContent = article.title;
            document.getElementById('article-date-category').innerHTML = `
                <span class="uppercase font-semibold text-sky-400">${article.category}</span>
                <span>â€¢</span>
                <span>${formatDate(article.date_published)}</span>
            `;
            document.getElementById('article-image').src = article.featured_image_url || `https://placehold.co/800x400/1e293b/94a3b8?text=${article.category.toUpperCase()}`;
            document.getElementById('article-image').style.display = article.featured_image_url ? 'block' : 'none';
            document.getElementById('article-intro').textContent = article.introduction;
            
            document.getElementById('article-content').innerHTML = renderContentBlocks(article.main_content);

            document.getElementById('claim-points').textContent = article.vcnews_claim_points;
            document.getElementById('claim-button').onclick = () => claimPoints('article_claim', article.vcnews_claim_points, article.id);

            let sourceHtml = '';
            if (article.sources && article.sources.length > 0) {
                sourceHtml += `<p class="font-bold">Sources:</p>`;
                article.sources.forEach(url => {
                    try {
                        sourceHtml += `<a href="${url}" target="_blank" class="block text-sky-400 hover:underline">${new URL(url).hostname}</a>`;
                    } catch (e) {
                         sourceHtml += `<span class="block text-red-400">Invalid URL: ${url}</span>`;
                    }
                });
            }
            document.getElementById('article-sources').innerHTML = sourceHtml;
        }

        async function fetchDailyQuest() {
             if (!supabaseClient) return;

            document.getElementById('quest-card').innerHTML = `<div id="quest-loading" class="text-center text-gray-500">Loading daily quest...</div>`;
            try {
                // Fetch the single active quest
                const { data: questData, error: questError } = await supabaseClient
                    .from('daily_quests')
                    .select('id, title, quest_points, tweet_url')
                    .eq('is_active', true)
                    .order('created_at', { ascending: false })
                    .limit(1);

                if (questError) throw questError;
                
                if (questData.length === 0) {
                    document.getElementById('quest-card').innerHTML = `
                        <p class="text-yellow-500 font-bold">No Active Quest Today</p>
                        <p class="text-gray-400 mt-2">Check back tomorrow for a new quest opportunity!</p>
                    `;
                    return;
                }

                const quest = questData[0];
                
                // Check completion using the quest_id and user_id 
                const { data: completionData, error: completionError } = await supabaseClient
                    .from('user_quest_completion')
                    .select('quest_id')
                    .eq('user_id', userId)
                    .eq('quest_id', quest.id)
                    .eq('completed_date', new Date().toISOString().slice(0, 10)); // YYYY-MM-DD format check

                if (completionError) throw completionError;

                let buttonHtml;
                if (completionData.length > 0) {
                    buttonHtml = `
                        <button class="bg-gray-600 text-white font-bold py-3 px-8 rounded-full cursor-not-allowed">
                            Quest Completed Today!
                        </button>
                    `;
                } else {
                    buttonHtml = `
                        <button onclick="claimPoints('daily_quest', ${quest.quest_points}, '${quest.id}')" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 px-8 rounded-full shadow-lg transition duration-300 transform hover:scale-[1.02]">
                            I've Submitted My Comment (Claim ${quest.quest_points} VCNEWS)
                        </button>
                    `;
                }

                document.getElementById('quest-card').innerHTML = `
                    <p class="text-sm font-bold text-yellow-500 uppercase">Active Daily Quest</p>
                    <h3 class="newspaper-title text-3xl my-2">${quest.title}</h3>
                    <p class="text-gray-300 mb-6">Your task is to comment on the target tweet below, then submit proof here.</p>
                    <div class="mb-8 p-3 bg-gray-800 rounded-lg">
                        <p class="text-sm text-gray-400 mb-2">Target Tweet URL:</p>
                        <a href="${quest.tweet_url}" target="_blank" class="text-sky-400 hover:underline break-all text-lg">${quest.tweet_url}</a>
                    </div>
                    ${buttonHtml}
                `;

            } catch (error) {
                showMessage(`Error loading quests: ${error.message}`, 'error');
                console.error("Quest Fetch Error:", error);
                document.getElementById('quest-card').innerHTML = `<p class="text-red-500">Failed to load quest.</p>`;
            }
        }

        async function fetchUserProfile() {
             if (!supabaseClient) return;

            document.getElementById('activity-log').innerHTML = '<p class="text-gray-500">Loading activity...</p>';
            document.getElementById('leaderboard-container').innerHTML = '<div class="text-center text-gray-500">Loading leaderboard...</div>';
            
            try {
                // 1. Fetch User Balance (Used for point display)
                const { data: balanceData, error: balanceError } = await supabaseClient
                    .from('user_balances')
                    .select('total_points')
                    .eq('user_id', userId)
                    .single();

                if (balanceError && balanceError.code !== 'PGRST116') { 
                    throw balanceError;
                }

                const totalPoints = balanceData ? balanceData.total_points : 0;
                document.getElementById('profile-points').textContent = totalPoints.toLocaleString();
                document.getElementById('leaderboard-user-points').textContent = totalPoints.toLocaleString() + ' VCNEWS';


                // 2. Fetch Leaderboard Data (Top 5 + User Rank)
                const { data: leaderboardData, error: leaderboardError } = await supabaseClient
                    .from('v_leaderboard')
                    .select('user_id, total_points, rank')
                    .limit(5); 
                
                if (leaderboardError) throw leaderboardError;

                // 2b. Find the user's specific rank 
                const { data: userRankData } = await supabaseClient
                    .from('v_leaderboard')
                    .select('rank')
                    .eq('user_id', userId)
                    .single();

                const userRank = userRankData ? userRankData.rank : 'N/A';
                document.getElementById('leaderboard-user-rank').textContent = userRank.toLocaleString();

                // 2c. Render Leaderboard
                document.getElementById('leaderboard-container').innerHTML = leaderboardData.map((miner, index) => {
                    const isCurrentUser = miner.user_id === userId;
                    const rankClass = index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-400' : 'text-gray-500';
                    const name = isCurrentUser ? 'You (Current Miner)' : `Miner ${index + 1}`;
                    const borderClass = isCurrentUser ? 'border-l-4 border-sky-500' : 'border-l-4 border-gray-700';

                    return `
                        <div class="flex justify-between items-center card p-3 rounded-lg ${borderClass}">
                            <span class="font-bold ${rankClass}">#${miner.rank}</span>
                            <span class="text-lg ${isCurrentUser ? 'font-bold' : ''}">${name}</span>
                            <span class="font-bold text-green-400">${miner.total_points.toLocaleString()} VCNEWS</span>
                        </div>
                    `;
                }).join('');


                // 3. Fetch Recent Activity
                const { data: activityData, error: activityError } = await supabaseClient
                    .from('user_activity_log')
                    .select('created_at, action_type, points_awarded')
                    .eq('user_id', userId)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (activityError) throw activityError;

                if (activityData.length === 0) {
                    document.getElementById('activity-log').innerHTML = '<p class="text-gray-500">No activity recorded yet.</p>';
                    return;
                }

                document.getElementById('activity-log').innerHTML = activityData.map(log => {
                    const actionText = log.action_type.replace('_', ' ').split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');
                    return `
                        <div class="flex justify-between items-center card p-3 rounded-lg transition-transform transform hover:translate-x-1 border-l-4 border-green-500">
                            <span class="text-gray-300 font-medium">${actionText}</span>
                            <span class="font-bold text-green-400">+${log.points_awarded.toLocaleString()} VCNEWS</span>
                            <span class="text-xs text-gray-500">${new Date(log.created_at).toLocaleDateString()}</span>
                        </div>
                    `;
                }).join('');

                // 4. Fetch User Twitter Profile (NEW)
                const twitterDisplayDiv = document.getElementById('twitter-display-section');
                twitterDisplayDiv.innerHTML = '<p class="text-gray-400">Loading Twitter profile...</p>';

                const { data: twitterData, error: twitterError } = await supabaseClient
                    .from('user_social_profiles')
                    .select('username')
                    .eq('user_id', userId)
                    .eq('platform', 'twitter') // Filter for Twitter only
                    .single();

                if (twitterError && twitterError.code !== 'PGRST116') {
                    console.error("Twitter Fetch Error:", twitterError);
                    twitterDisplayDiv.innerHTML = '<p class="text-red-400">Error fetching Twitter data.</p>';
                } else {
                    if (twitterData) {
                        // Twitter linked, display it
                        twitterDisplayDiv.innerHTML = `
                            <p class="text-gray-300">Your Linked X Username:</p>
                            <a href="https://twitter.com/${twitterData.username}" target="_blank" class="text-2xl font-bold break-all text-white hover:text-sky-400 transition">@${twitterData.username}</a>
                            <p class="text-xs text-gray-500 mt-1">Required for completing social media quests.</p>
                            <button onclick="document.getElementById('twitter-update-form').classList.toggle('hidden')" class="text-sm text-sky-400 hover:text-sky-300 mt-2">Update Username</button>
                            <div id="twitter-update-form" class="hidden mt-4">
                                <input id="twitter-username-input" type="text" placeholder="Enter new X username (without @)" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500 mb-3" />
                                <button id="twitter-submit-button" onclick="submitTwitterUsername()" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                                    Update Username
                                </button>
                            </div>
                        `;
                    } else {
                        // No Twitter linked, show submission form
                        twitterDisplayDiv.innerHTML = `
                            <p class="text-gray-300 mb-3">Link your X (Twitter) profile to participate in social quests.</p>
                            <input id="twitter-username-input" type="text" placeholder="Enter X username (without @)" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-sky-500 mb-3" />
                            <button id="twitter-submit-button" onclick="submitTwitterUsername()" class="bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                                Submit Username
                            </button>
                        `;
                    }
                }


                // 5. Fetch User Wallet Status (Existing Logic)
                const walletDisplayDiv = document.getElementById('wallet-display-section');
                walletDisplayDiv.innerHTML = '<p class="text-gray-400">Loading wallet...</p>';

                const { data: walletData, error: walletError } = await supabaseClient
                    .from('user_wallets')
                    .select('wallet_address, status')
                    .eq('user_id', userId)
                    .single();

                if (walletError && walletError.code !== 'PGRST116') { // PGRST116: No rows found
                    console.error("Wallet Fetch Error:", walletError);
                    walletDisplayDiv.innerHTML = '<p class="text-red-400">Error fetching wallet data.</p>';
                } else {
                    if (walletData) {
                        // Wallet is linked, display it
                        const statusColor = walletData.status === 'verified' ? 'text-green-400' : 'text-yellow-400';
                        const statusText = walletData.status === 'verified' ? 'Verified' : 'Pending Verification';
                        
                        walletDisplayDiv.innerHTML = `
                            <p class="text-gray-300">Your Linked EVM Wallet:</p>
                            <p class="text-xl font-mono break-all text-white">${walletData.wallet_address}</p>
                            <div class="flex items-center space-x-2 mt-2">
                                <span class="text-sm font-bold ${statusColor} uppercase">${statusText}</span>
                                <span class="text-xs text-gray-500">VCNEWS TGE tokens will be sent here.</span>
                            </div>
                            <button onclick="document.getElementById('wallet-update-form').classList.toggle('hidden')" class="text-sm text-sky-400 hover:text-sky-300 mt-2">Update Wallet Address</button>
                            <div id="wallet-update-form" class="hidden mt-4">
                                <p class="text-sm text-yellow-500 mb-2">Warning: Changing your wallet requires re-verification and is subject to anti-spam checks.</p>
                                <input id="wallet-address-input" type="text" placeholder="Enter new 0x... address" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 mb-3" />
                                <button id="wallet-submit-button" onclick="submitWalletAddress()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                                    Update Wallet
                                </button>
                            </div>
                        `;

                    } else {
                        // No wallet linked, show submission form
                        walletDisplayDiv.innerHTML = `
                            <p class="text-gray-300 mb-3">Link your EVM (0x...) wallet to receive your tokens at TGE.</p>
                            <input id="wallet-address-input" type="text" placeholder="Enter 0x... wallet address" class="w-full p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 border border-gray-600 focus:outline-none focus:ring-2 focus:ring-purple-500 mb-3" />
                            <button id="wallet-submit-button" onclick="submitWalletAddress()" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg w-full transition duration-300">
                                Submit Wallet
                            </button>
                        `;
                    }
                }

            } catch (error) {
                showMessage(`Error loading portfolio: ${error.message}`, 'error');
                console.error("Profile Fetch Error:", error);
            }
        }
        
        // --- Collaboration View Functions ---
        
        /** Renders the main Collabs Hub list */
        function renderCollabsList() {
            const listContainer = document.getElementById('collabs-list');
            listContainer.innerHTML = ''; 

            Object.keys(collaborations).forEach(key => {
                const collab = collaborations[key];
                const isComingSoon = collab.status !== 'Live';

                const card = document.createElement('div');
                card.className = 'card p-4 rounded-xl shadow-md border-l-4 border-purple-500 cursor-pointer hover:bg-gray-700 transition-colors flex justify-between items-center';
                
                // Clicking opens the detail view (sub-page)
                card.onclick = () => navigate('collab_detail', key);

                card.innerHTML = `
                    <div>
                        <p class="text-lg font-bold text-white">${collab.name}</p>
                        <p class="text-sm text-gray-400">Status: <span class="${isComingSoon ? 'text-yellow-400' : 'text-green-400'}">${collab.status}</span></p>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-extrabold text-green-400">${collab.supply_percent}</p>
                        <p class="text-xs text-gray-500">VCNEWS Supply</p>
                    </div>
                `;
                listContainer.appendChild(card);
            });
            
            // Add the Dedicated Leaderboard "Coming Soon" card separately as a featured item
            listContainer.innerHTML += `
                <div class="card p-4 rounded-xl bg-gray-800 border-l-4 border-sky-500 mt-6">
                    <p class="text-lg font-bold text-sky-400">Dedicated Campaign Leaderboard</p>
                    <p class="text-sm text-gray-400 mt-1">Status: <span class="text-yellow-400">Coming Soon</span></p>
                    <p class="text-xs text-gray-500 mt-2">All community collaborations will feature their own real-time leaderboard, accessible from the detail pages.</p>
                </div>
            `;
        }

        /** Renders the detail page (sub-page) for a specific collaboration */
        function renderCollabDetail(collabKey) {
            const collab = collaborations[collabKey];
            if (!collab) {
                showMessage('Collaboration details not found.', 'error');
                navigate('collabs');
                return;
            }

            document.getElementById('collab-detail-title').textContent = collab.name;
            const contentDiv = document.getElementById('collab-detail-content');

            let detailHTML = `
                <div class="mb-6 p-4 bg-gray-800 rounded-lg space-y-3">
                    <p class="text-xl font-bold text-yellow-300">Campaign Status: ${collab.status}</p>
                    <p class="text-gray-400"><strong>VCNEWS Pool:</strong> <span class="text-green-400">${collab.supply_percent}</span> of Total Supply</p>
                    <p class="text-gray-400"><strong>Goal:</strong> ${collab.goal}</p>
                    <p class="text-gray-400"><strong>Partner Profile:</strong> <a href="${collab.partner_link}" target="_blank" class="text-sky-400 hover:underline">${collab.partner_profile}</a></p>
                </div>

                <h3 class="text-2xl font-bold text-white mb-3">Partner Introduction</h3>
                <p class="text-gray-300 mb-6">${collab.bio}</p>

                <h3 class="text-2xl font-bold text-white mb-3">Full Campaign Details</h3>
                ${collab.details.length > 0 ? 
                    `<ul class="list-disc list-inside space-y-2 text-gray-300 ml-4">
                        ${collab.details.map(d => `<li>${d}</li>`).join('')}
                    </ul>` : 
                    `<p class="text-yellow-400">Detailed campaign tasks and timeline will be announced soon!</p>`
                }
                
                <h3 class="text-2xl font-bold text-sky-500 mb-3 mt-6 border-t border-gray-700 pt-4">Campaign Leaderboard</h3>
                <div class="p-4 bg-gray-800 rounded-lg border-l-4 border-red-500">
                     <p class="font-bold text-red-400">LEADERBOARD COMING SOON</p>
                     <p class="text-sm text-gray-400">A dedicated real-time leaderboard for the ${collab.name} campaign will be live shortly after launch, tracking all participants. Check back soon!</p>
                </div>
            `;
            
            contentDiv.innerHTML = detailHTML;
        }


        window.claimPoints = async function(actionType, points, contextId) {
            if (!userId) {
                showMessage("You must be logged in to claim points.", 'error');
                return;
            }
            if (!supabaseClient) return;

            const button = document.activeElement;
            const originalText = button.innerHTML;
            button.disabled = true;
            button.innerHTML = '<span class="flex items-center justify-center"><svg class="animate-spin h-5 w-5 mr-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>PROCESSING...</span>';

            try {
                // IMPORTANT: Call the Supabase RPC function
                const { data, error } = await supabaseClient.rpc('fn_award_points', {
                    p_user_id: userId,
                    p_action_type: actionType,
                    p_requested_points: points,
                    p_context_id: contextId
                });

                if (error) throw error;
                
                const result = data;
                
                if (result.awarded_points > 0) {
                    showMessage(`Success! ${result.message} Awarded: ${result.awarded_points.toLocaleString()} VCNEWS!`, 'success');
                } else {
                    showMessage(`Claim Failed: ${result.message}`, 'error');
                }

                if (actionType === 'daily_quest') {
                    fetchDailyQuest(); // Refresh quest view to show 'Completed' status
                }

                if (actionType === 'article_claim' && result.awarded_points > 0) {
                     // Disable the article button after successful claim
                     button.classList.add('bg-gray-600', 'cursor-not-allowed');
                     button.classList.remove('bg-green-600', 'hover:bg-green-700');
                     button.textContent = `Claimed ${result.awarded_points} VCNEWS`;
                }

            } catch (error) {
                showMessage(`Transaction Error: ${error.message}`, 'error');
                console.error("RPC Error:", error);
            } finally {
                if (button.textContent.includes('PROCESSING...')) {
                    // Only restore the button if it wasn't permanently changed by a successful claim
                    if (!button.classList.contains('cursor-not-allowed')) {
                        button.innerHTML = originalText;
                        button.disabled = false;
                    }
                }
                
                fetchUserProfile(); // Refresh profile/leaderboard
            }
        }
        
        // Initialize the Application on Window Load
        window.onload = initApp;

    </script>
</body>
</html>
